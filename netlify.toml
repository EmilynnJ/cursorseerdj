# =============================================================================
# Netlify deployment configuration for SoulSeer Django application
#
# Architecture:
#   - Django WSGI app runs as a Netlify serverless function (Python 3.11)
#   - Static files are collected and served directly from Netlify CDN
#   - Celery workers (billing ticks, session finalization) must run separately
#     on Fly.io or another platform that supports persistent processes
#
# Required environment variables — set in Netlify UI → Site Settings → Env:
#   SECRET_KEY, DATABASE_URL, REDIS_URL, AUTH0_DOMAIN, AUTH0_APP_ID,
#   AUTH0_CLIENT_SECRET, AUTH0_AUDIENCE, AGORA_APP_ID,
#   AGORA_SECURITY_CERTIFICATE, STRIPE_SECRET_KEY, STRIPE_PUBLISHABLE_KEY,
#   STRIPE_WEBHOOK_SIGNING_SECRET, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,
#   R2_BUCKET, R2_ENDPOINT
# =============================================================================

[build]
  # Collect static files; Django app itself is served via the function below
  command = "pip install -r requirements.txt && python manage.py collectstatic --noinput"
  publish  = "staticfiles"
  functions = "netlify/functions"

[build.environment]
  PYTHON_VERSION            = "3.11"
  DJANGO_SETTINGS_MODULE    = "soulseer.settings"
  # Tell Django it is behind Netlify's HTTPS proxy so SSL redirect works correctly
  DJANGO_SECURE_PROXY_SSL   = "1"

# ---------------------------------------------------------------------------
# Function settings
# ---------------------------------------------------------------------------
[functions]
  # Include all Python source, templates, and migration files in the bundle
  included_files = [
    "**/*.py",
    "templates/**",
    "staticfiles/**",
    "**/migrations/**",
  ]

# ---------------------------------------------------------------------------
# Redirects — static assets served from CDN, everything else → Django
# ---------------------------------------------------------------------------

# Static files: let Netlify serve them directly (already in publish dir)
[[redirects]]
  from   = "/static/*"
  to     = "/static/:splat"
  status = 200

# Stripe webhook must reach Django — explicit rule before catch-all
[[redirects]]
  from   = "/stripe/webhook/"
  to     = "/.netlify/functions/django"
  status = 200
  force  = true

# All other requests → Django serverless function
[[redirects]]
  from   = "/*"
  to     = "/.netlify/functions/django"
  status = 200
  force  = true

# ---------------------------------------------------------------------------
# Headers — aggressive caching for immutable static assets
# ---------------------------------------------------------------------------
[[headers]]
  for = "/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options   = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy   = "strict-origin-when-cross-origin"
