{% extends 'base.html' %}
{% load humanize %}
{% block title %}{{ stream.title }} - SoulSeer{% endblock %}
{% block extra_head %}
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.24.2.js" onerror="this.onerror=null"></script>
{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <div class="flex justify-between items-start mb-6">
    <div>
      <h1 class="font-heading text-4xl text-soulseer-pink">{{ stream.title }}</h1>
      <p class="font-body text-white/70 mt-1">{{ stream.reader.get_full_name|default:stream.reader.username }}</p>
      <span class="inline-block px-2 py-1 text-xs rounded mt-2
        {% if stream.visibility == 'public' %}bg-green-900/50 text-green-400
        {% elif stream.visibility == 'premium' %}bg-soulseer-pink/20 text-soulseer-pink
        {% else %}bg-gray-800 text-gray-400{% endif %}">
        {{ stream.visibility|title }}
      </span>
    </div>
    {% if user == stream.reader and not stream.ended_at %}
    <form method="post" action="{% url 'end_stream' stream.pk %}">
      {% csrf_token %}
      <button type="submit" onclick="return confirm('End this stream?')"
        class="px-4 py-2 rounded bg-red-900/30 text-red-400 border border-red-500/50 hover:bg-red-900/50 transition font-body">
        End Stream
      </button>
    </form>
    {% endif %}
  </div>

  {% if stream.ended_at %}
  <div class="p-6 rounded border border-white/20 bg-soulseer-darker/50 text-center">
    <p class="font-body text-white/60">This stream has ended.</p>
    <a href="{% url 'live_list' %}" class="mt-4 inline-block text-soulseer-pink hover:underline">← Back to Live</a>
  </div>
  {% elif not can_view %}
  <div class="p-6 rounded border border-soulseer-pink/30 bg-soulseer-darker/50 text-center">
    <p class="font-body text-white/70 mb-4">This is a private stream.</p>
    <a href="{% url 'login' %}" class="px-6 py-3 rounded bg-soulseer-pink/20 text-soulseer-pink border border-soulseer-pink hover:bg-soulseer-pink/30 transition">Login to Join</a>
  </div>
  {% else %}
  <div class="grid gap-8 md:grid-cols-3">
    <div class="md:col-span-2">
      <!-- Video container -->
      <div id="live-video" class="w-full bg-black rounded-lg border border-soulseer-pink/30 flex items-center justify-center" style="min-height:400px;">
        <p class="text-white/40 font-body" id="video-placeholder">Connecting to stream...</p>
      </div>
      <div class="mt-4 flex gap-3">
        {% if user == stream.reader %}
        <button id="start-broadcast" class="px-4 py-2 rounded bg-green-900/30 text-green-400 border border-green-500/50 hover:bg-green-900/50 transition font-body">
          Start Broadcasting
        </button>
        {% else %}
        <button id="join-stream" class="px-4 py-2 rounded bg-soulseer-pink/20 text-soulseer-pink border border-soulseer-pink hover:bg-soulseer-pink/30 transition font-body">
          Join Stream
        </button>
        {% endif %}
      </div>
    </div>

    <div class="space-y-6">
      <!-- Gifts -->
      {% if user.is_authenticated and user != stream.reader %}
      <section class="p-5 rounded-lg border border-soulseer-pink/30 bg-soulseer-darker/50">
        <h3 class="font-heading text-xl text-soulseer-pink mb-4">Send a Gift</h3>
        <form method="post" action="{% url 'send_gift' stream.pk %}" class="space-y-3">
          {% csrf_token %}
          {% for g in gifts %}
          <button type="submit" name="gift_id" value="{{ g.pk }}"
            class="w-full px-4 py-2 rounded bg-soulseer-pink/10 text-soulseer-pink border border-soulseer-pink/40 hover:bg-soulseer-pink/20 transition font-body text-left">
            {{ g.name }} — ${{ g.price|floatformat:2 }}
          </button>
          {% empty %}
          <p class="text-white/50 text-sm font-body">No gifts available.</p>
          {% endfor %}
        </form>
      </section>
      {% endif %}

      <!-- Stream info -->
      <section class="p-5 rounded-lg border border-soulseer-pink/30 bg-soulseer-darker/50 font-body">
        <h3 class="font-heading text-xl text-soulseer-pink mb-3">Stream Info</h3>
        <p class="text-white/70 text-sm">Started: {{ stream.started_at|date:"M d, Y H:i" }}</p>
        <p class="text-white/70 text-sm mt-1">Gifts sent: {{ stream.gifts.count }}</p>
      </section>
    </div>
  </div>
  {% endif %}
</div>

{% if not stream.ended_at and can_view %}
<script>
(function() {
  const appId = '{{ AGORA_APP_ID|escapejs }}';
  const channel = '{{ stream.agora_channel|escapejs }}';
  const streamId = {{ stream.pk }};
  const isReader = {{ user == stream.reader|lower }};
  const csrfToken = '{{ csrf_token }}';

  if (!appId || typeof AgoraRTC === 'undefined') return;

  const client = AgoraRTC.createClient({ mode: 'live', codec: 'vp8' });
  client.setClientRole(isReader ? 'host' : 'audience');

  async function getToken() {
    const resp = await fetch('/api/livestreams/' + streamId + '/rtc-token/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
      credentials: 'same-origin',
    });
    return await resp.json();
  }

  client.on('user-published', async (user, mediaType) => {
    await client.subscribe(user, mediaType);
    document.getElementById('video-placeholder').style.display = 'none';
    if (mediaType === 'video') user.videoTrack.play('live-video');
    if (mediaType === 'audio') user.audioTrack.play();
  });

  const startBtn = document.getElementById('start-broadcast') || document.getElementById('join-stream');
  if (startBtn) {
    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      try {
        const data = await getToken();
        await client.join(data.appId || appId, channel, data.token, data.uid);
        if (isReader) {
          const audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
          const videoTrack = await AgoraRTC.createCameraVideoTrack();
          await client.publish([audioTrack, videoTrack]);
          videoTrack.play('live-video');
          document.getElementById('video-placeholder').style.display = 'none';
        }
        startBtn.textContent = isReader ? 'Live' : 'Watching';
      } catch (e) {
        alert('Error: ' + e.message);
        startBtn.disabled = false;
      }
    });
  }
})();
</script>
{% endif %}
{% endblock %}
