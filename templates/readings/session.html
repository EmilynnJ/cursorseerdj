{% extends 'base.html' %}
{% load humanize static %}
{% block title %}Session - SoulSeer{% endblock %}
{% block extra_head %}
<script src="{% static 'vendor/agora/AgoraRTC_N-4.24.2.js' %}"></script>
{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-16">
  <h1 class="font-heading text-5xl text-soulseer-pink mb-8">Reading Session</h1>
  
  <div class="grid gap-4 md:grid-cols-3 mb-8">
    <div class="p-4 rounded border border-soulseer-pink/30 bg-soulseer-darker/50">
      <p class="text-white/60 text-sm">Session ID</p>
      <p class="text-xl text-white">#{{ session.pk }}</p>
    </div>
    <div class="p-4 rounded border border-soulseer-pink/30 bg-soulseer-darker/50">
      <p class="text-white/60 text-sm">Status</p>
      <p class="text-xl {% if session.state == 'active' %}text-green-400{% elif session.state == 'ended' or session.state == 'finalized' %}text-red-400{% else %}text-amber-400{% endif %}">
        {{ session.get_state_display }}
      </p>
    </div>
    <div class="p-4 rounded border border-soulseer-pink/30 bg-soulseer-darker/50">
      <p class="text-white/60 text-sm">Billing</p>
      <p class="text-xl text-white">{{ session.billing_minutes }} min @ ${{ session.rate_per_minute }}/min</p>
    </div>
  </div>

  {% if session.state == 'reconnecting' %}
  <div class="mb-6 p-4 rounded bg-amber-900/30 border border-amber-500/50 text-amber-400">
    <p class="font-bold">Reconnecting...</p>
    <p class="text-sm">Grace period expires {{ session.grace_until|timeuntil }}.</p>
  </div>
  {% endif %}

  {% csrf_token %}
  
  <div id="agora-container" class="mt-8 {% if session.state == 'ended' or session.state == 'finalized' %}opacity-50{% endif %}">
    <div class="grid gap-4 md:grid-cols-2">
      <div id="local-player" class="w-full h-64 bg-soulseer-darker rounded border border-soulseer-pink/30 flex items-center justify-center">
        <span class="text-white/40">Your camera</span>
      </div>
      <div id="remote-player" class="w-full h-64 bg-soulseer-darker rounded border border-soulseer-pink/30 flex items-center justify-center">
        <span class="text-white/40">Remote participant</span>
      </div>
    </div>
    
    <div class="mt-6 flex flex-wrap gap-4">
      {% if session.state != 'ended' and session.state != 'finalized' %}
        <button id="join-btn" class="px-6 py-3 rounded bg-green-900/30 text-green-400 border border-green-500/50 hover:bg-green-900/50 transition">
          Join Channel
        </button>
        <button id="leave-btn" class="px-6 py-3 rounded bg-amber-900/30 text-amber-400 border border-amber-500/50 hover:bg-amber-900/50 transition" disabled>
          Disconnect
        </button>
        <button id="end-btn" class="px-6 py-3 rounded bg-red-900/30 text-red-400 border border-red-500/50 hover:bg-red-900/50 transition">
          End Session
        </button>
      {% else %}
        <p class="text-white/60 py-3">Session has ended.</p>
      {% endif %}
    </div>
  </div>

  {% if session.summary %}
  <div class="mt-8 p-6 rounded border border-soulseer-pink/30 bg-soulseer-darker/50">
    <h3 class="font-heading text-xl text-soulseer-pink mb-2">Session Summary</h3>
    <p class="text-white/80 font-body">{{ session.summary }}</p>
  </div>
  {% endif %}
</div>

<script id="session-data" type="application/json">
{
  "sessionId": {{ session.pk }},
  "appId": "{{ AGORA_APP_ID|default:''|escapejs }}",
  "sessionState": "{{ session.state|escapejs }}"
}
</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const dataEl = document.getElementById('session-data');
  const data = JSON.parse(dataEl.textContent);
  
  const sessionId = data.sessionId;
  const appId = data.appId;
  const sessionState = data.sessionState;
  
  if (!appId) { 
    document.getElementById('agora-container').innerHTML = '<p class="text-amber-400">Agora not configured</p>'; 
    return; 
  }
  
  if (sessionState === 'ended' || sessionState === 'finalized') {
    return;
  }
  
  const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
  let localAudioTrack = null;
  let localVideoTrack = null;
  
  const joinBtn = document.getElementById('join-btn');
  const leaveBtn = document.getElementById('leave-btn');
  const endBtn = document.getElementById('end-btn');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  client.on('user-published', async function(user, mediaType) {
    await client.subscribe(user, mediaType);
    if (mediaType === 'video') {
      user.videoTrack.play('remote-player');
    }
    if (mediaType === 'audio') {
      user.audioTrack.play();
    }
  });
  
  client.on('user-unpublished', function(user, mediaType) {
    if (mediaType === 'video') {
      document.getElementById('remote-player').innerHTML = '<span class="text-white/40 flex items-center justify-center h-full">Remote participant disconnected</span>';
    }
  });
  
  client.on('connection-state-change', function(curState, prevState) {
    console.log('Connection state:', prevState, '->', curState);
    if (curState === 'DISCONNECTED' || curState === 'FAILED') {
      fetch('/sessions/' + sessionId + '/disconnect/', {
        method: 'POST',
        headers: { 
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        credentials: 'same-origin'
      });
    }
  });
  
  joinBtn.addEventListener('click', async function() {
    joinBtn.disabled = true;
    try {
      const response = await fetch('/api/sessions/' + sessionId + '/rtc-token/', {
        method: 'POST',
        headers: { 
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json' 
        },
        credentials: 'same-origin'
      });
      const result = await response.json();
      if (!response.ok) throw new Error(result.error || 'Failed to get token');
      
      localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      localVideoTrack = await AgoraRTC.createCameraVideoTrack();
      await client.join(appId, result.channel, result.token, result.uid);
      await client.publish([localAudioTrack, localVideoTrack]);
      localVideoTrack.play('local-player');
      
      leaveBtn.disabled = false;
      joinBtn.textContent = 'Connected';
      joinBtn.classList.remove('bg-green-900/30', 'text-green-400', 'border-green-500/50');
      joinBtn.classList.add('bg-soulseer-pink/20', 'text-soulseer-pink', 'border-soulseer-pink');
    } catch (err) {
      alert('Error joining: ' + err.message);
      joinBtn.disabled = false;
    }
  });
  
  leaveBtn.addEventListener('click', async function() {
    await fetch('/sessions/' + sessionId + '/disconnect/', {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      credentials: 'same-origin'
    });
    
    await client.leave();
    if (localAudioTrack) localAudioTrack.close(); 
    if (localVideoTrack) localVideoTrack.close();
    
    leaveBtn.disabled = true;
    joinBtn.disabled = false;
    joinBtn.textContent = 'Rejoin Channel';
    joinBtn.classList.add('bg-green-900/30', 'text-green-400', 'border-green-500/50');
    joinBtn.classList.remove('bg-soulseer-pink/20', 'text-soulseer-pink', 'border-soulseer-pink');
  });
  
  endBtn.addEventListener('click', async function() {
    if (!confirm('Are you sure you want to end this session?')) return;
    
    await client.leave();
    if (localAudioTrack) localAudioTrack.close(); 
    if (localVideoTrack) localVideoTrack.close();
    
    window.location.href = '/sessions/' + sessionId + '/end/';
  });
});
</script>
{% endblock %}